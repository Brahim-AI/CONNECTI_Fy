<!DOCTYPE html>
<html lang="ar" dir="ltr">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Connectify-chat</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=send" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=mic" />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Poppins:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css"
    />

    <style>
      /* --- 0. UNIVERSAL FIX --- */
      * {
        box-sizing: border-box;
      }

      /* --- 1. GLOBAL VARIABLES --- */
      :root {
        --bg-deep: #020b1a;
        --neon-purple: #d946ef;
        --neon-blue: #00f2ff;
        --neon-red: #ff0055;
        --glass-bg: rgba(20, 20, 20, 0.7);
        --gradient-neon: linear-gradient(135deg, #00c2ff 0%, #bc13fe 100%);
      }

      body {
        background-color: #000;
        color: white;
        font-family: "Poppins", "Cairo", sans-serif;
        height: 100vh;
        width: 100vw;
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 0;
        overflow: hidden;
        background-image: url("https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?w=1000&q=80");
        background-size: cover;
        background-position: center;
      }

      /* --- 2. MAIN CONTAINER --- */
      .mobile-container {
        width: 100%;
        max-width: 600px;
        height: 95vh;
        background: radial-gradient(circle at top, #0f1c35 0%, #020610 100%);
        backdrop-filter: blur(20px);
        display: flex;
        flex-direction: column;
        position: relative;
        border: 2px solid var(--neon-blue);
        border-radius: 30px;
        box-shadow: 0 0 30px rgba(0, 242, 255, 0.3);
        overflow: hidden;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        transition: background-image 0.3s ease;
      }

      @media (max-width: 768px) {
        body {
          background-image: none !important;
          background-color: #000;
        }
        .mobile-container {
          width: 100% !important;
          max-width: 100% !important;
          height: 100dvh !important;
          border: none !important;
          border-radius: 0 !important;
          box-shadow: none !important;
          margin: 0 !important;
        }
        .input-emoji-picker {
          width: 90% !important;
          left: 5% !important;
          bottom: 80px !important;
        }
      }

      /* --- 3. HEADER --- */
      .chat-header {
        background: rgba(2, 6, 16, 0.6);
        padding: 15px 20px;
        border-bottom: 1px solid rgba(0, 242, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: space-between;
        z-index: 10;
        backdrop-filter: blur(5px);
        flex-shrink: 0;
      }
      .user-avatar-small {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        color: #fff;
        background: #222;
        border: 2px solid var(--neon-blue);
        box-shadow: 0 0 15px var(--neon-blue);
      }
      .header-icon {
        color: var(--neon-blue);
        font-size: 1.4rem;
        cursor: pointer;
        transition: 0.3s;
      }
      .header-icon:hover {
        color: var(--neon-purple);
        text-shadow: 0 0 10px var(--neon-purple);
      }
      .wallpaper-icon {
        color: white;
        font-size: 1.3rem;
        cursor: pointer;
        transition: 0.3s;
        text-shadow: 0 0 5px white;
      }
      .wallpaper-icon:hover {
        color: var(--neon-blue);
        text-shadow: 0 0 15px var(--neon-blue);
        transform: rotate(15deg);
      }

      /* --- 4. CHAT BODY --- */
      .chat-body {
        background-color: rgba(2, 6, 16, 0.9);
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 20px;
        padding-bottom: 20px;
      }
      .chat-body::-webkit-scrollbar {
        width: 5px;
      }
      .chat-body::-webkit-scrollbar-thumb {
        background: var(--neon-blue);
        border-radius: 10px;
      }

      .message-wrapper {
        display: flex;
        align-items: flex-end;
        position: relative;
        animation: messageSlideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }
      @keyframes messageSlideIn {
        from { opacity: 0; transform: translateY(20px) scale(0.9); }
        to { opacity: 1; transform: translateY(0) scale(1); }
      }

      .message-bubble {
        padding: 10px 18px;
        border-radius: 20px;
        font-size: 1rem;
        max-width: 85%;
        position: relative;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        gap: 5px;
        word-wrap: break-word;
        word-break: break-word;
      }

      .message-received { justify-content: flex-start; }
      .message-received .message-bubble {
         background: rgba(40, 0, 40, 0.6) !important; 
        border: 2px solid var(--neon-purple);
        box-shadow: 0 0 15px rgba(0, 242, 255, 0.25), inset 0 0 10px rgba(0, 242, 255, 0.05);
        color: #e0faff;
        backdrop-filter: blur(5px);
        border-bottom-left-radius: 5px;
      }
      .message-received .audio-avatar {
        border-color: var(--neon-blue) !important;
        box-shadow: 0 0 10px var(--neon-blue) !important;
      }

      .message-sent { justify-content: flex-end; }
      .message-sent .message-bubble {
        background: rgba(0, 20, 40, 0.6) !important;
        border: 2px solid var(--neon-blue);
        box-shadow: 0 0 15px rgba(0, 20, 40, 0.6), inset 0 0 10px rgba(0, 242, 255, 0.05);
        color: #fceaff;
        backdrop-filter: blur(5px);
        border-bottom-right-radius: 5px;
        font-weight: 500;
      }

      .reply-in-bubble {
        background-color: rgba(255, 255, 255, 0.1);
        padding: 6px 10px;
        border-radius: 8px;
        margin-bottom: 5px;
        border-left: 4px solid var(--neon-blue);
        display: flex;
        flex-direction: column;
        justify-content: center;
        overflow: hidden;
      }
      .reply-in-bubble small {
        display: block;
        font-size: 0.75rem;
        font-weight: 700;
        color: var(--neon-blue);
        margin-bottom: 2px;
      }
      .reply-in-bubble .reply-content {
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        gap: 5px;
        width: 100%;
      }
      .reply-thumb-img {
        width: 40px;
        height: 40px;
        object-fit: cover;
        border-radius: 6px;
        margin-left: 10px;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      .reply-media-preview-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
      }

      .message-image {
        border-radius: 15px;
        max-width: 100%;
        display: block;
        margin-bottom: 5px;
      }
      .message-caption {
        font-size: 0.9rem;
        margin-top: 5px;
        color: #f1f1f1;
      }

      /* --- Actions Menu --- */
     .message-actions-overlay {
  position: absolute;
  /* ÿ∑ŸÑÿπŸÜÿßŸáÿß ÿ¥ŸàŸäÿ© ŸÉÿ™ÿ± ÿ®ÿßÿ¥ ÿ™ÿ¨Ÿä ŸÑÿßÿµŸÇÿ© */
  top: 55px; 
  width: fit-content;
  
  
  /* ÿßŸÑÿÆŸÑŸÅŸäÿ© */
  background: rgba(20, 20, 20, 0.95);
  backdrop-filter: blur(10px);
  
  /* ÿßŸÑÿ≠ÿ¨ŸÖ: ŸáŸÜÿß ŸÅŸäŸÜ ŸÉŸÜŸÇÿµŸà */
  /* ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑŸÑŸàŸÑ (4px) ŸÑŸÑÿ∑ŸàŸÑÿå ŸàÿßŸÑÿ±ŸÇŸÖ ÿßŸÑÿ´ÿßŸÜŸä (10px) ŸÑŸÑÿπÿ±ÿ∂ */
  padding: 4px 1px; 
  width: 60%;
  border-radius: 50px; /* ÿ¥ŸÉŸÑ ÿØÿßÿ¶ÿ±Ÿä */
  
  display: none;
  align-items: center;
  
  /* ÿßŸÑŸÖÿ≥ÿßŸÅÿ© ÿ®ŸäŸÜ ÿßŸÑÿ≤ÿ± ŸàÿßŸÑÿ≤ÿ± (gap) ŸÜŸÇÿµŸÜÿßŸáÿß */
  gap: 8px; 
  
  z-index: 100;
  opacity: 0;
  transition: all 0.2s ease;
  white-space: nowrap;
  border: 1px solid rgba(255, 255, 255, 0.1);
  box-shadow: 0 4px 10px rgba(0,0,0,0.4);
}

.message-sent .message-actions-overlay { left: auto; right: 0; }
.message-received .message-actions-overlay { left: 0; right: auto; }

.message-actions-overlay.visible {
  transform: translateY(5px); 
  display: flex;
  opacity: 1;
  border-color: var(--neon-blue);
  box-shadow: 0 0 10px rgba(0, 242, 255, 0.2);
  font-size: 0.1px;
}

/* ŸáÿßÿØ ÿßŸÑŸÉŸÑÿßÿ≥ ÿ®ÿßÿ¥ ŸÜÿµÿ∫ÿ±Ÿà ÿ≠ÿ™Ÿâ ÿßŸÑŸÉÿ™ÿßÿ®ÿ© ŸàÿßŸÑÿ£ŸäŸÇŸàŸÜÿßÿ™ */
.action-btn {
  /* ÿµÿ∫ÿ±ŸÜÿß ÿßŸÑÿÆÿ∑ */
  font-size: 0.75rem; 
  color: #ccc;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 4px;
  transition: 0.3s;
  padding-right: 50px; /* ŸÜŸÇÿµŸÜÿß ÿßŸÑŸÖÿ≥ÿßŸÅÿ© ÿ®ŸäŸÜÿßÿ™ŸáŸÖ */
}

/* ÿ™ÿµÿ∫Ÿäÿ± ÿßŸÑÿ£ŸäŸÇŸàŸÜÿßÿ™ */
.action-btn i {
    font-size: 0.7rem;
}
 /* --- STYLE 2: MODERN FLOATING ISLAND --- */
/* --- STYLE 2 FIX: MOBILE --- */
@media (max-width: 480px) {
  /* 1. L-·∏§ala l-3adiya (Mkhbbiya) */
  .message-actions-overlay {
    display: none; /* ‚ö†Ô∏è Hna khassha tkoun mkhbbiya f l-bdaya */
    
    /* Design w Dimensions */
    width: max-content;
    max-width: 85vw;
    padding: 12px;
    background: rgba(15, 23, 42, 0.95);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 24px;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.6);
    
    /* Positioning */
    position: absolute; /* Muhim bash tji foq l-message */
    top: 100%;
    margin-top: 8px;
    left: 50% !important;
    transform: translateX(-50%) !important;
    z-index: 100;
    
    overflow: visible;
  }

  /* 2. L-·∏§ala Mlli Kat-cliki (Visible) */
  /* Hna fin kan-affichiw l-menu w kandiro Flexbox */
  .message-actions-overlay.visible {
    display: flex;       /* ‚ö†Ô∏è 3ad kandiro flex hna */
    flex-wrap: wrap;     /* Bash maykounch scroll */
    justify-content: center;
    align-items: center;
    gap: 8px;
    
    /* Animation sghira bash tban b style */
    animation: popUpMobile 0.2s ease-out forwards;
  }

  /* --- Design d Buttons & Icons (B7al li 9bel) --- */
  .action-btn {
    font-size: 0.7rem;
    color: #e2e8f0;
    background: rgba(255, 255, 255, 0.08);
    padding: 6px 14px;
    border-radius: 100px;
    border: 1px solid transparent;
    margin: 2px 0;
    flex-grow: 1;
    justify-content: center;
  }
  
  .action-btn:active {
    background: rgba(255, 255, 255, 0.15);
    border-color: var(--neon-blue);
  }

  .action-btn i {
    font-size: 0.8rem;
    color: var(--neon-blue);
  }

  .emoji-reaction {
    font-size: 1.1rem;
    padding: 6px;
    border-radius: 12px;
    transition: transform 0.2s;
  }
  
  .emoji-reaction:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: scale(1.2);
     cursor: pointer;
  }

  /* Design d Plus (+) */
  .message-actions-overlay .emoji-reaction.action-btn {
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, rgba(217, 70, 239, 0.2), rgba(0, 242, 255, 0.2));
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: 6px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    flex-grow: 0;
   
  }

  .message-actions-overlay .emoji-reaction.action-btn i {
    color: white;
    font-size: 1.2rem;
  }
}

/* Animation bach tban zwin mlli t-cliki */
@keyframes popUpMobile {
  from { opacity: 0; transform: translateX(-50%) translateY(10px) scale(0.9); }
  to { opacity: 1; transform: translateX(-50%) translateY(0) scale(1); }
}
      /* --- REACTION STYLES --- */
      .reaction-display {
        position: absolute;
        bottom: -15px;
        left: 5px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        padding: 2px 5px;
        border-radius: 15px;
        font-size: 0.8rem;
        box-shadow: 0 0 5px rgba(0, 242, 255, 0.5);
        z-index: 5;
        cursor: pointer;
        display: none;
      }
      .message-sent .reaction-display {
        left: auto;
        right: 5px;
        background: rgba(0, 0, 0, 0);
        border: 1px solid rgba(217, 70, 239, 0.5);
      }
      .heart-reaction {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0);
        font-size: 4rem;
        color: var(--neon-red);
        text-shadow: 0 0 20px var(--neon-red);
        z-index: 100;
        pointer-events: none;
        animation: heartPop 0.8s ease-out forwards;
      }
      @keyframes heartPop {
        0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
        30% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
        50% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        100% { transform: translate(-50%, -50%) scale(2); opacity: 0; }
      }
      .bi bi-heart-fill liked-badge{
          position: fixed;
          
          
       
        
        

      }
      .liked-badge {
        position: absolute;
        bottom: -10px;
        right: 25px;
        font-size: 1rem;
        color: var(--neon-red);
        background: rgba(0, 0, 0, 0.7);
        border-radius: 50%;
        padding: 2px;
        width: 25px;
        animation: popIn 0.3s ease-out;
        z-index: 6;
      }
      .message-received .liked-badge { right: auto; left: 25px; }
      @keyframes popIn {
        from { transform: scale(0); }
        to { transform: scale(1); }
      }

      /* --- FOOTER & INPUT --- */
      .chat-footer {
        background: rgba(2, 6, 16, 0.9);
        backdrop-filter: blur(15px);
        padding: 10px 15px;
        border-top: 2px solid rgba(0, 242, 255, 0.3);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        position: relative;
        height: 75px;
        z-index: 20;
        box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.5);
        flex-shrink: 0;
       
      }
      .footer-icons-group {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .hidden { display: none !important; }
      
      .footer-icon {
        color: #aaa;
        font-size: 1.5rem;
        cursor: pointer;
        transition: 0.3s;
      }
      .footer-icon:hover {
        color: var(--neon-blue);
        text-shadow: 0 0 10px var(--neon-blue);
      }

      @keyframes inputPulse {
        0% { box-shadow: 0 0 10px rgba(188, 19, 254, 0.3); border-color: rgba(188, 19, 254, 0.4); }
        50% { box-shadow: 0 0 25px rgba(0, 242, 255, 0.6); border-color: var(--neon-blue); }
        100% { box-shadow: 0 0 10px rgba(188, 19, 254, 0.3); border-color: rgba(188, 19, 254, 0.4); }
      }
      .input-placeholder-area {
        flex-grow: 1;
        padding: 10px 15px;
        background: #0a1120;
        border-radius: 50px;
        border: 1px solid rgba(0, 242, 255, 0.4);
        color: white;
        font-size: 1rem;
        outline: none;
        transition: 0.3s;
        min-width: 0;
      }
      .input-placeholder-area:focus {
        border-color: var(--neon-blue);
        box-shadow: 0 0 10px rgba(0, 242, 255, 0.3);
      }
      .input-placeholder-area.typing-active {
        animation: inputPulse 1.5s infinite;
        background: rgba(20, 20, 20, 0.9);
      }

      .action-circle-btn {
        background: #d946ef;
        width: 45px;
        height: 45px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        box-shadow: 0 0 15px var(--neon-purple);
        transition: 0.3s;
        flex-shrink: 0;
      }
      .action-circle-btn:hover { transform: scale(1.05); }
      .action-circle-btn i { font-size: 1.3rem; color: white; }

      /* --- INPUT EMOJI PICKER --- */
      .input-emoji-btn {
        cursor: pointer;
        transition: 0.3s;
        margin-right: 5px;
        color: #aaa;
      }
      .input-emoji-btn:hover {
        color: var(--neon-purple);
        text-shadow: 0 0 10px var(--neon-purple);
        transform: scale(1.1);
      }
      .input-emoji-picker {
        position: absolute;
        bottom: 80px;
        left: 20px;
        width: 300px;
        height: 250px;
        background: rgba(2, 6, 16, 0.95);
        border: 1px solid var(--neon-purple);
        backdrop-filter: blur(15px);
        border-radius: 15px;
        display: none;
        grid-template-columns: repeat(6, 1fr);
        padding: 10px;
        overflow-y: auto;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
        z-index: 100;
        max-width: 90vw;
      }
      .input-emoji-picker span {
        font-size: 1.5rem;
        text-align: center;
        cursor: pointer;
        padding: 5px;
      }
      .input-emoji-picker span:hover {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 5px;
      }

      /* --- OTHER UI ELEMENTS --- */
      .reply-ui {
        position: absolute;
        bottom: 75px;
        left: 0;
        width: 100%;
        background: #181818;
        border-top: 1px solid #333;
        padding: 10px 20px;
        z-index: 15;
        display: none;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.5);
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
        animation: slideUp 0.2s ease-out;
      }
      @keyframes slideUp {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
      .reply-container-box {
        flex-grow: 1;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        border-left: 5px solid var(--neon-purple);
        padding: 8px 12px;
        margin-right: 15px;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
      .reply-close {
        font-size: 1.8rem;
        color: #888;
        cursor: pointer;
        padding: 5px;
      }
      .reply-close:hover { color: var(--neon-red); }

      /* Audio Player & Avatar */
      .custom-audio-player {
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid var(--neon-blue);
        padding: 8px 10px;
        border-radius: 50px;
        display: flex;
        align-items: center;
        gap: 8px;
        width: fit-content;
        box-shadow: 0 0 15px rgba(0, 242, 255, 0.3);
        max-width: 100%;
      }
      .audio-play-circle {
        width: 35px;
        height: 35px;
        background: var(--gradient-nen);
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        flex-shrink: 0;
        
      }
      .audio-play-circle i { font-size: 1.1rem; margin-left: 2px; }
      .audio-white-bar {
        background: transparent;
        height: 35px;
        border-radius: 50px;
        display: flex;
        align-items: center;
        padding: 0 5px;
        gap: 10px;
        min-width: 120px;
        flex-wrap: nowrap;
        overflow: hidden;
      }
      .audio-wave-container {
        display: flex;
        align-items: center;
        gap: 2px;
        height: 18px;
        flex-grow: 1;
      }
      .wave-bar {
        width: 3px;
        border-radius: 4px;
        height: 100%;
        animation: audioWave 1s infinite ease-in-out;
        animation-play-state: paused;
      }
      .wave-bar:nth-child(odd) { background: var(--neon-purple); box-shadow: 0 0 10px var(--neon-purple); }
      .wave-bar:nth-child(even) { background: var(--neon-blue); box-shadow: 0 0 10px var(--neon-blue); }
      .wave-active .wave-bar { animation-play-state: running !important; }
      @keyframes audioWave {
        0%, 100% { transform: scaleY(0.6); }
        50% { transform: scaleY(1.8); }
      }
      .audio-time {
        font-size: 0.7rem;
        color: rgba(255, 255, 255, 0.8);
        font-weight: 600;
        margin-left: auto;
        white-space: nowrap;
      }
      .audio-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        margin-left: 8px;
        border: 2px solid var(--neon-blue);
        box-shadow: 0 0 10px var(--neon-blue);
        flex-shrink: 0;
      }
      .message-received .audio-avatar { border-color: var(--neon-blue); box-shadow: 0 0 10px var(--neon-blue); }

      /* --- Recording UI FIXED --- */
      .recording-ui {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 75px;
        background: #0a0a0a;
        border-top: 2px solid var(--neon-purple);
        display: none;
        /* FIX: Better Flex Alignment */
        align-items: center;
        justify-content: space-between;
        padding: 0 15px;
        z-index: 50;
        animation: slideUpRec 0.3s ease-out;
        gap: 15px; /* Add gap between elements */
      }
      @keyframes slideUpRec {
        from { transform: translateY(10px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
      .record-delete {
        color: #888;
        font-size: 1.5rem;
        cursor: pointer;
        transition: 0.3s;
        flex-shrink: 0;
      }
      .record-delete:hover {
        color: var(--neon-red);
        text-shadow: 0 0 10px var(--neon-red);
      }
      .record-info {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-shrink: 0;
      }
      .record-dot {
        width: 10px;
        height: 10px;
        background: #a1143a;
        border-radius: 50%;
        animation: blinkNeon 1.5s infinite;
      }
      @keyframes blinkNeon {
        0% { opacity: 1; }
        50% { opacity: 0.4; }
        100% { opacity: 1; }
      }
      .record-send-btn {
        background: var(--gradient-neon);
        color: white;
        width: 45px;
        height: 45px;
        border-radius: 15px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        font-size: 1.2rem;
        flex-shrink: 0;
      }

      /* Overlays */
      #imagePreviewOverlay,
      #cameraOverlay,
      #emojiPickerOverlay,
      #deleteModal {
        display: none;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 3000;
      }
      #imagePreviewOverlay {
        background: #000;
        flex-direction: column;
        border: 3px solid var(--neon-purple);
      }
      /* Remove border on mobile preview */
      @media (max-width: 768px) {
        #imagePreviewOverlay { border: none; }
      }
      .preview-top-bar {
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        background: rgba(0, 0, 0, 0.5);
      }
      .preview-tools {
        display: flex;
        gap: 20px;
        font-size: 1.4rem;
        color: var(--neon-blue);
      }
      .preview-image-container {
        flex: 1;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
        overflow: hidden;
      }
      #previewMedia {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
      }
      .preview-bottom-bar {
        padding: 15px 20px;
        background: #0a0a0a;
        border-top: 1px solid rgba(0, 242, 255, 0.3);
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .preview-caption-input {
        flex: 1;
        background: #1c1c1c;
        border: 1px solid #444;
        color: white;
        border-radius: 25px;
        padding: 12px 20px;
        outline: none;
        min-width: 0;
      }
      .preview-send-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: var(--gradient-neon);
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.3rem;
        cursor: pointer;
        color: white;
        flex-shrink: 0;
      }

      /* --- CAMERA VIDEO FIX --- */
      #cameraOverlay {
          background-color: black;
          display: none;
          flex-direction: column;
      }
      #cameraVideo {
          /* FIX: Ensure video covers screen correctly */
          width: 100%;
          height: 100%;
          object-fit: cover; 
          position: absolute;
          top: 0;
          left: 0;
          z-index: 1;
      }
      #closeCameraBtn {
          position: absolute;
          top: 20px;
          right: 20px;
          font-size: 2rem;
          color: white;
          z-index: 10;
          cursor: pointer;
          background: rgba(0,0,0,0.5);
          width: 40px;
          height: 40px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
      }
      .camera-controls-bottom {
          position: absolute;
          bottom: 40px;
          width: 100%;
          display: flex;
          justify-content: center;
          z-index: 10;
      }
      #captureBtn {
          width: 70px;
          height: 70px;
          border-radius: 50%;
          background: white;
          border: 4px solid rgba(255,255,255,0.5);
          cursor: pointer;
          transition: 0.2s;
      }
      #captureBtn:active { transform: scale(0.9); }

      #emojiPickerOverlay {
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(15px);
        z-index: 5000;
        flex-direction: column;
        padding: 20px;
      }
      .emoji-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
        gap: 10px;
        overflow-y: auto;
        padding-top: 20px;
      }
      .emoji-grid span {
        font-size: 2.5rem;
        text-align: center;
        cursor: pointer;
        transition: transform 0.1s;
      }
      .emoji-grid span:hover { transform: scale(1.15); }

      #deleteModal {
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(5px);
        z-index: 6000;
        justify-content: center;
        align-items: center;
      }
      .modal-content-delete {
        background: #1c1c1c;
        padding: 30px;
        border-radius: 20px;
        width: 80%;
        border: 2px solid var(--neon-red);
        text-align: center;
        max-width: 400px;
      }
      .modal-btn-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
        align-items: center;
      }
      .modal-btn-group button {
        background: var(--neon-red);
        color: white;
        border: none;
        padding: 10px 20px;
        width: 100%;
        border-radius: 10px;
        cursor: pointer;
      }
      .cancel-btn { background: #333 !important; }

      #copyToast {
        visibility: hidden;
        min-width: 250px;
        background-color: rgba(10, 10, 10, 0.95);
        color: #fff;
        text-align: center;
        border-radius: 50px;
        padding: 16px;
        position: fixed;
        z-index: 10000;
        left: 50%;
        bottom: 120px;
        transform: translateX(-50%);
        border: 1px solid var(--neon-blue);
        opacity: 0;
        transition: opacity 0.3s, bottom 0.3s;
      }
      #copyToast.show { visibility: visible; opacity: 1; bottom: 130px; }

      .view-once-toggle {
        width: 30px;
        height: 30px;
        border: 2px dotted #888;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        color: #888;
        cursor: pointer;
        margin-right: 10px;
        flex-shrink: 0;
      }
      .view-once-toggle.active {
        border-style: solid;
        border-color: var(--neon-blue);
        background: rgba(0, 242, 255, 0.2);
        color: var(--neon-blue);
      }
      .view-once-bubble-content {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 5px 0;
        cursor: pointer;
        font-weight: 600;
        color: #ccc;
      }
      .view-once-icon-circle {
        width: 24px;
        height: 24px;
        border: 2px solid currentColor;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 0.7rem;
        font-weight: bold;
      }
      .view-once-opened { color: #888 !important; font-style: italic; }

      /* --- 5. RESPONSIVE & ADAPTIVE UPDATES --- */
      @media screen and (min-width: 601px) and (max-width: 1024px) {
        .mobile-container { width: 90%; max-width: 100%; height: 98vh; }
      }
      @media screen and (max-width: 380px) {
        .chat-footer { padding: 5px 8px; gap: 5px; }
        .input-placeholder-area { font-size: 0.9rem; padding: 8px 12px; }
        .footer-icons-group { gap: 8px; }
        .action-circle-btn { width: 38px; height: 38px; }
        .header-icon { font-size: 1.2rem; }
      }
      /* --- 1. IKHFAE SCROLLBAR (Chat Body) --- */
.chat-body::-webkit-scrollbar {
  display: none; /* Hada howa li kaykhbbiha merra */
  width: 0;      /* Ziyada d l-i·∏•tiyat */
}

/* --- 2. TSGHIR REPLY UI --- */
.reply-ui {
  /* N99asna l-padding men 10px/20px l 5px/10px */
  padding: 5px 10px !important; 
  min-height: 50px; /* Bash matkounch kbira bzaf */
  align-items: center;
}

.reply-container-box {
  /* N99asna l-padding dakhil l-box */
  padding: 4px 10px !important;
  border-left-width: 3px !important; /* N99asna smk d l-khat l-mlowwen */
}

.reply-container-box small {
  /* Sgherna smit l-user */
  font-size: 0.7rem !important;
  margin-bottom: 0 !important;
}

.reply-content {
  /* Sgherna l-message */
  font-size: 0.75rem !important;
}

.reply-close {
  /* Sgherna l-icon d l-ighlaq */
  font-size: 1.4rem !important;
  padding: 0 5px !important;
}
/* --- Attachment Menu Styles --- */
.attach-menu-dropdown {
  position: absolute;
  bottom: 60px; /* ÿ®ÿßÿ¥ ÿ™ÿ¨Ÿä ŸÅŸàŸÇ ÿßŸÑÿ®Ÿàÿ™ŸàŸÜ */
  left: 0;
  background: rgba(10, 16, 30, 0.95);
  border: 1px solid var(--neon-blue);
  border-radius: 15px;
  padding: 10px;
  display: none; /* ŸÖÿÆÿ®Ÿäÿ© ŸÅÿßŸÑÿ®ÿØÿßŸäÿ© */
  flex-direction: column;
  gap: 10px;
  min-width: 140px;
  backdrop-filter: blur(10px);
  box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
  z-index: 100;
  animation: slideUpMenu 0.2s ease-out;
}

@keyframes slideUpMenu {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.attach-item {
  display: flex;
  align-items: center;
  gap: 10px;
  color: white;
  padding: 8px 12px;
  cursor: pointer;
  border-radius: 8px;
  transition: 0.3s;
  font-size: 0.9rem;
}

.attach-item:hover {
  background: rgba(0, 242, 255, 0.15);
  color: var(--neon-blue);
}

.attach-item i {
  font-size: 1.1rem;
  color: var(--neon-purple);
}

/* ŸÉŸÑÿßÿ≥ ÿ®ÿßÿ¥ ŸÜÿ®ŸäŸÜŸà ÿßŸÑŸÖŸäŸÜŸà */
.attach-menu-visible {
  display: flex !important;
}
/* Styling for the Crop Confirm/Cancel buttons */
.crop-controls {
    align-items: center;
    background: rgba(0,0,0,0.6);
    padding: 5px 15px;
    border-radius: 20px;
    border: 1px solid #333;
}

/* Styling for the Multi-photo Thumbnails */
.mini-thumb {
    width: 50px;
    height: 50px;
    border-radius: 8px;
    object-fit: cover;
    border: 2px solid transparent;
    cursor: pointer;
    opacity: 0.6;
    transition: 0.2s;
    flex-shrink: 0;
}

.mini-thumb.active-thumb {
    border-color: var(--neon-blue);
    opacity: 1;
    transform: scale(1.1);
}
    </style>
  </head>
  <body>
    <input
      type="file"
      id="galleryInput"
      accept="image/*,video/*"
      style="display: none"
    />
    <input
      type="file"
      id="wallpaperInput"
      accept="image/*"
      style="display: none"
    />

    <div id="emojiPickerOverlay">
      <div
        class="preview-top-bar"
        style="background: transparent; border-bottom: 1px solid rgba(255, 255, 255, 0.1);"
      >
        <i
          class="bi bi-x-lg"
          style="color: white; font-size: 1.5rem; cursor: pointer"
          id="closeEmojiPickerBtn"
        ></i>
        <h4 style="color: var(--neon-blue); margin: 0">Emoji Reactions</h4>
      </div>
      <div class="emoji-grid" id="emojiGrid"></div>
    </div>

    <div id="deleteModal">
      <div class="modal-content-delete">
        <h4 class="text-white mb-4 fw-bold">Delete Message?</h4>
        <div class="modal-btn-group">
          <button class="cancel-btn" id="deleteCancelBtn">Cancel</button>
          <button id="deleteForMeBtn" style="display: none">
            Delete for me
          </button>
        </div>
      </div>
    </div>

    <div class="mobile-container">
      <div id="imagePreviewOverlay">
        <div class="preview-top-bar" id="previewTopBar">
    <i class="bi bi-x-lg" style="color: white; font-size: 1.5rem; cursor: pointer" id="closePreviewBtn"></i>
    
    <div class="preview-tools" id="previewTools">
        <i class="bi bi-crop preview-tool-icon" id="btnCrop"></i>
        <i class="bi bi-arrow-clockwise preview-tool-icon" id="btnRotate"></i>
        <i class="bi bi-magic preview-tool-icon" id="btnEnhance"></i>
    </div>

    <div class="crop-controls" id="cropControls" style="display: none; gap: 20px;">
        <i class="bi bi-x-lg" id="btnCropCancel" style="color: #ff0055; font-size: 1.5rem; cursor: pointer;"></i>
        <i class="bi bi-check-lg" id="btnCropDone" style="color: #00f2ff; font-size: 1.5rem; cursor: pointer;"></i>
    </div>
</div>

<div id="mediaThumbnails" style="display: flex; gap: 10px; padding: 10px 20px; overflow-x: auto; background: rgba(0,0,0,0.3);">
    </div>

<div class="preview-bottom-bar" id="previewBottomBar">
   </div>
        <div class="preview-image-container">
          <div
            id="previewMediaContainer"
            style="
              width: 100%;
              height: 100%;
              display: flex;
              justify-content: center;
              align-items: center;
            "
          ></div>
        </div>
        <div class="preview-bottom-bar" id="previewBottomBar">
          <div
            style="font-size: 1.5rem; color: #888; cursor: pointer"
            id="changeMediaInPreviewBtn"
          >
            <i class="bi bi-plus-circle-fill"></i>
          </div>
          <input
            type="text"
            id="captionInput"
            class="preview-caption-input"
            placeholder="Add a caption..."
          />
          <div id="viewOnceToggle" class="view-once-toggle">1</div>
          <div class="preview-send-btn" id="confirmSendImgBtn">
            <span class="material-symbols-outlined">send</span>
          </div>
        </div>
      </div>

      <div id="cameraOverlay">
        <div id="closeCameraBtn"><i class="bi bi-x-lg"></i></div>
        <video id="cameraVideo" autoplay playsinline></video>
        <canvas id="cameraCanvas" style="display: none"></canvas>
        <div class="camera-controls-bottom"><div id="captureBtn"></div></div>
      </div>

      

      <div class="chat-body" id="chatBody">
        <div class="message-wrapper message-received" data-message-id="1">
          <div class="message-bubble" onclick="toggleActions(event, this)">
            ÿßŸÑÿ≥ŸÑÿßŸÖ ÿπŸÑŸäŸÉŸÖÿå ŸÉŸäŸÅ ÿßŸÑÿ≠ÿßŸÑÿü
          </div>
          <div class="message-actions-overlay">
            <span
              class="action-btn"
              onclick="replyToMessage(this, 'Al Mahamuod', 'ÿßŸÑÿ≥ŸÑÿßŸÖ ÿπŸÑŸäŸÉŸÖÿå ŸÉŸäŸÅ ÿßŸÑÿ≠ÿßŸÑÿü')"
              ><i class="bi bi-arrow-return-left"></i>R√©pondre</span
            >
            <span class="action-btn" onclick="copyMessage(this)"
              ><i class="bi bi-copy"></i>Copier</span
            >
          </div>
        </div>
        <div class="message-wrapper message-sent" data-message-id="2">
          <div class="message-bubble" onclick="toggleActions(event, this)">
            <div>Ÿáÿ∞ÿß ŸÖŸäÿ≥Ÿëÿßÿ¨ ŸÑÿ™ÿ¨ÿ±ÿ®ÿ© ÿÆÿßÿµŸäÿ© ÿßŸÑŸÖÿ≥ÿ≠ ŸàÿßŸÑÿ±ÿØ.</div>
          </div>
          <div class="message-actions-overlay">
            <span
              class="action-btn"
              onclick="replyToMessage(this, 'You', 'Ÿáÿ∞ÿß ŸÖŸäÿ≥Ÿëÿßÿ¨ ŸÑÿ™ÿ¨ÿ±ÿ®ÿ© ÿÆÿßÿµŸäÿ© ÿßŸÑŸÖÿ≥ÿ≠ ŸàÿßŸÑÿ±ÿØ.')"
              ><i class="bi bi-arrow-return-left"></i>R√©pondre</span
            >
            <span class="action-btn" onclick="copyMessage(this)"
              ><i class="bi bi-copy"></i>Copier</span
            >
          </div>
        </div>
      </div>

      <div class="reply-ui" id="replyUI">
        <div class="reply-container-box" id="replyContainerBox">
          <small id="replyingToUser">Al Mahamuod</small>
          <div id="replyTextPreview" class="reply-content">
            Text goes here...
          </div>
        </div>
        <i class="bi bi-x-lg reply-close" id="closeReplyUI"></i>
      </div>

      <div class="chat-footer">
        <div class="input-emoji-picker" id="inputEmojiPicker"></div>

      <div class="footer-icons-group" id="iconsGroup" style="position: relative;">
  
  <div id="attachMenu" class="attach-menu-dropdown">
    <div class="attach-item" id="triggerCamera">
      <i class="bi bi-camera-fill"></i> Camera
    </div>
    <div class="attach-item" id="triggerGallery">
      <i class="bi bi-image"></i> Gallery
    </div>
  </div>

  <i class="bi bi-paperclip footer-icon" id="toggleAttachBtn" style="font-size: 1.7rem; transform: rotate(45deg);"></i>
</div>

        <i
          class="bi bi-emoji-smile footer-icon input-emoji-btn"
          id="triggerInputEmoji"
          style="margin-left: 10px"
        ></i>

        <input
          type="text"
          id="msgInput"
          class="input-placeholder-area"
          placeholder="Type message..."
        />
        <div class="action-circle-btn" id="actionBtn">
          
           <span class="material-symbols-outlined" id="micIcon">mic</span>
         
           <span class="material-symbols-outlined"id="sendIcon" style="display: none ">send</span>
        </div>

        <div class="recording-ui" id="recordingUI">
          <i class="bi bi-trash3 record-delete" id="cancelRecordBtn"></i>
          <div class="audio-wave-container wave-active" id="recordingWave">
            <div class="wave-bar" style="height: 15px"></div>
            <div class="wave-bar" style="height: 20px"></div>
            <div class="wave-bar" style="height: 25px"></div>
            <div class="wave-bar" style="height: 18px"></div>
            <div class="wave-bar" style="height: 22px"></div>
            <div class="wave-bar" style="height: 16px"></div>
            <div class="wave-bar" style="height: 21px"></div>
          </div>
          <div class="record-info">
            <div class="record-dot"></div>
            <span class="timer-text" id="recordTime">0:00</span>
          </div>
          <div class="record-send-btn" id="sendRecordBtn">
            <span class="material-symbols-outlined">send</span>
          </div>
        </div>
      </div>
    </div>

    <div id="copyToast">
      <i
        class="bi bi-check-circle-fill"
        style="color: var(--neon-blue); margin-right: 8px"
      ></i
      >Message Copied!
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script>
      /* --- Variables --- */
const msgInput = document.getElementById("msgInput");
const iconsGroup = document.getElementById("iconsGroup");
const actionBtn = document.getElementById("actionBtn");
const micIcon = document.getElementById("micIcon");
const sendIcon = document.getElementById("sendIcon");
const chatBody = document.getElementById("chatBody");
const userStatus = document.getElementById("userStatus");
/* --- User Specific Storage Key --- */
// ŸÉŸÜÿ¨Ÿäÿ®Ÿà ÿ≥ŸÖŸäÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖŸÜ ÿßŸÑÿ±ÿßÿ®ÿ∑ URL
const urlParams = new URLSearchParams(window.location.search);
const currentUserChatID = urlParams.get('user') || 'default'; // ÿ•ŸÑÿß ŸÖÿßŸÑŸÇÿßÿ¥ ÿßŸÑÿ≥ŸÖŸäÿ© ÿ∫Ÿäÿ≥ŸÖŸäŸá default

// ŸáÿßÿØŸä ŸáŸä ÿßŸÑÿ≥ÿßÿ±Ÿàÿ™ ÿ®ÿßÿ¥ ÿ∫ŸÜÿ≥ÿ¨ŸÑŸà ŸÑŸÉŸÑ Ÿàÿßÿ≠ÿØ ÿ®Ÿàÿ≠ÿØŸà
const CHAT_HISTORY_KEY = `savedChatHistory_${currentUserChatID}`;
const CHAT_REACTIONS_KEY = `chatReactions_${currentUserChatID}`;

/* Reply Elements */
const replyUI = document.getElementById("replyUI");
const closeReplyUI = document.getElementById("closeReplyUI");
const replyContainerBox = document.getElementById("replyContainerBox");
const replyingToUser = document.getElementById("replyingToUser");
const replyTextPreview = document.getElementById("replyTextPreview");

/* Recording Vars */
const recordingUI = document.getElementById("recordingUI");
const recordTime = document.getElementById("recordTime");
const cancelRecordBtn = document.getElementById("cancelRecordBtn");
const sendRecordBtn = document.getElementById("sendRecordBtn");
let isRecording = false;
let mediaRecorder;
let audioChunks = [];
let timerInterval;
let seconds = 0;
let typingTimer;

/* Camera/Gallery Vars */
const triggerCamera = document.getElementById("triggerCamera");
const galleryInput = document.getElementById("galleryInput");
const triggerGallery = document.getElementById("triggerGallery");
const imagePreviewOverlay = document.getElementById("imagePreviewOverlay");
const closePreviewBtn = document.getElementById("closePreviewBtn");
const confirmSendImgBtn = document.getElementById("confirmSendImgBtn"); 
const captionInput = document.getElementById("captionInput");
const cameraOverlay = document.getElementById("cameraOverlay");
const cameraVideo = document.getElementById("cameraVideo");
const captureBtn = document.getElementById("captureBtn");
const closeCameraBtn = document.getElementById("closeCameraBtn");
const cameraCanvas = document.getElementById("cameraCanvas");
const changeMediaInPreviewBtn = document.getElementById("changeMediaInPreviewBtn");

/* View Once Vars */
const viewOnceToggle = document.getElementById("viewOnceToggle");
let isViewOnceMode = false;
let isViewingViewOnce = false;
let stream = null;
let currentMediaUrl = null;
let currentMediaType = "image";

/* New Emoji/Delete Vars */
const emojiPickerOverlay = document.getElementById("emojiPickerOverlay");
const closeEmojiPickerBtn = document.getElementById("closeEmojiPickerBtn");
const emojiGrid = document.getElementById("emojiGrid");
const deleteModal = document.getElementById("deleteModal");
const deleteCancelBtn = document.getElementById("deleteCancelBtn");
const deleteForMeBtnCloneTarget = document.getElementById("deleteForMeBtn");
const modalBtnGroup = deleteModal.querySelector(".modal-btn-group");

/* --- NEW VARIABLES FOR CROP & MULTI-SELECT --- */
let mediaQueue = []; 
let currentMediaIndex = 0;
const btnCropCancel = document.getElementById("btnCropCancel");
const btnCropDone = document.getElementById("btnCropDone");
const cropControls = document.getElementById("cropControls");
const previewTools = document.getElementById("previewTools");
const mediaThumbnails = document.getElementById("mediaThumbnails");
const closePreviewBtnIcon = document.getElementById("closePreviewBtn");

const EMOJI_LIST = ["üëç", "‚ù§Ô∏è", "üòÇ", "üò¢", "üòÆ", "üôè", "üî•", "üíØ", "ü§Ø", "ü•≥"];
let selectedMessageForAction = null;

/* --- Active Reply State --- */
let activeReplyData = {
  id: null,
  user: "",
  text: "",
  preview: "",
  mediaUrl: null,
  mediaType: null,
};

/* --- 0. SAVE CHAT HELPER (NEW) --- */
/* --- 0. SAVE CHAT HELPER (UPDATED) --- */
function saveChatToStorage() {
  if(chatBody) {
    // ŸáŸÜÿß ÿ®ÿØŸÑŸÜÿß ÿßŸÑŸÖŸÅÿ™ÿßÿ≠ ÿßŸÑÿ´ÿßÿ®ÿ™ ÿ®ÿßŸÑŸÖŸÅÿ™ÿßÿ≠ ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ±
    localStorage.setItem(CHAT_HISTORY_KEY, chatBody.innerHTML);
  }
}

/* --- HELPERS FOR STORAGE --- */
/* --- HELPERS FOR STORAGE (UPDATED) --- */
function updateReactionStorage(msgId, type, emoji, action) {
  // ÿ≠ÿ™Ÿâ ŸáŸÜÿß ÿ®ÿØŸÑŸÜÿß ÿßŸÑŸÖŸÅÿ™ÿßÿ≠ ÿ®ÿßÿ¥ ÿßŸÑÿ™ŸÅÿßÿπŸÑÿßÿ™ ŸÖÿßÿ™ÿÆŸÑÿ∑ÿ¥
  let reactions = JSON.parse(localStorage.getItem(CHAT_REACTIONS_KEY) || "{}");
  if (action === "add") {
    reactions[msgId] = { type: type, emoji: emoji };
  } else if (action === "remove") {
    delete reactions[msgId];
  }
  localStorage.setItem(CHAT_REACTIONS_KEY, JSON.stringify(reactions));
}

/* --- 1. Typing Logic --- */
msgInput.addEventListener("input", function () {
  if (this.value.trim().length > 0) {
    iconsGroup.classList.add("hidden");
    micIcon.style.display = "none";
    sendIcon.style.display = "block";
    this.classList.add("typing-active");
  } else {
    iconsGroup.classList.remove("hidden");
    micIcon.style.display = "block";
    sendIcon.style.display = "none";
    this.classList.remove("typing-active");
  }
  if (this.value.length > 0) {
    userStatus.innerText = "Typing...";
    userStatus.style.color = "#00f2ff";
    clearTimeout(typingTimer);
    typingTimer = setTimeout(() => {
      if (!isRecording) userStatus.innerText = "Online";
    }, 2000);
  } else {
    if (!isRecording) userStatus.innerText = "Online";
  }
});
msgInput.addEventListener("blur", function () {
  this.classList.remove("typing-active");
});
msgInput.addEventListener("keypress", function (event) {
  if (event.key === "Enter") sendMessage(msgInput.value);
});

/* --- 2. Action Menu Handling --- */
document.addEventListener("click", (e) => {
  if (
    !e.target.closest(".message-bubble") &&
    !e.target.closest(".message-actions-overlay") &&
    !e.target.closest("#emojiPickerOverlay") &&
    !e.target.closest("#deleteModal")
  ) {
    hideAllActions();
  }
});

window.toggleActions = function (event, bubble) {
  event.preventDefault();
  hideAllActions();
  const wrapper = bubble.parentNode;
  const overlay = wrapper.querySelector(".message-actions-overlay");
  if (overlay) {
    setupEmojiActions(wrapper);
    setupDeleteAction(wrapper);
    try {
      const actionBtns = Array.from(overlay.querySelectorAll(".action-btn"));
      const copyBtn = actionBtns.find((btn) => btn.innerHTML.includes("bi-copy"));
      if (copyBtn) {
        const clone = bubble.cloneNode(true);
        const selectorsToRemove = [".reply-in-bubble", ".reaction-display", ".custom-audio-player", ".view-once-bubble-content", "img", "video", ".liked-badge"];
        selectorsToRemove.forEach((sel) => {
          const els = clone.querySelectorAll(sel);
          els.forEach((el) => el.remove());
        });
        const cleanText = clone.innerText.trim();
        if (cleanText.length > 0) copyBtn.style.display = "flex";
        else copyBtn.style.display = "none";
      }
    } catch (err) {}
    overlay.classList.add("visible");
    selectedMessageForAction = wrapper;
  }
};

function hideAllActions() {
  document.querySelectorAll(".message-actions-overlay.visible").forEach((overlay) => overlay.classList.remove("visible"));
  emojiPickerOverlay.style.display = "none";
  deleteModal.style.display = "none";
}

/* === COPY FUNCTION === */
window.copyMessage = function (el) {
  const wrapper = el.closest(".message-wrapper");
  const bubble = wrapper.querySelector(".message-bubble");
  let textToCopy = "";
  if (bubble) {
    const clone = bubble.cloneNode(true);
    [".reply-in-bubble", ".reaction-display", ".liked-badge", ".custom-audio-player", ".view-once-bubble-content"].forEach(sel => {
        const elem = clone.querySelector(sel);
        if(elem) elem.remove();
    });
    textToCopy = clone.innerText.trim();
  }
  if (textToCopy && textToCopy.length > 0) {
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(textToCopy)
        .then(() => { hideAllActions(); showToast(); })
        .catch((err) => fallbackCopyText(textToCopy));
    } else {
      fallbackCopyText(textToCopy);
    }
  } else {
    hideAllActions();
  }
};

function fallbackCopyText(text) {
  const textArea = document.createElement("textarea");
  textArea.value = text;
  textArea.style.position = "fixed"; 
  textArea.style.top = "0"; textArea.style.left = "0";
  document.body.appendChild(textArea);
  textArea.focus();
  textArea.select();
  try {
    const successful = document.execCommand("copy");
    if (successful) { hideAllActions(); showToast(); }
  } catch (err) {}
  document.body.removeChild(textArea);
}

function showToast() {
  const toast = document.getElementById("copyToast");
  toast.className = "show";
  setTimeout(function () {
    toast.className = toast.className.replace("show", "");
  }, 3000);
}

/* --- 7. Emoji Logic --- */
function setupEmojiActions(wrapper) {
  const overlay = wrapper.querySelector(".message-actions-overlay");
  overlay.querySelectorAll(".emoji-reaction").forEach((e) => e.remove());
  EMOJI_LIST.slice(0, 5).reverse().forEach((emoji) => {
    const span = document.createElement("span");
    span.className = "emoji-reaction";
    span.innerText = emoji;
    span.onclick = (e) => setReaction(e, wrapper, emoji);
    overlay.prepend(span);
  });
  const moreBtn = document.createElement("span");
  moreBtn.className = "emoji-reaction action-btn";
  moreBtn.innerHTML = '<i class="bi bi-plus" style="font-size:1.8rem; color:white;"></i>';
  moreBtn.style.borderRight = "none"; moreBtn.style.marginRight = "0";
  moreBtn.onclick = (e) => openEmojiPicker(e, wrapper);
  overlay.prepend(moreBtn);
}

function openEmojiPicker(event, wrapper) {
  event.stopPropagation();
  selectedMessageForAction = wrapper;
  hideAllActions();
  emojiPickerOverlay.style.display = "flex";
}

closeEmojiPickerBtn.addEventListener("click", () => {
  emojiPickerOverlay.style.display = "none";
  selectedMessageForAction = null;
});

EMOJI_LIST.forEach((emoji) => {
  const span = document.createElement("span");
  span.innerText = emoji;
  span.onclick = (e) => {
    if (selectedMessageForAction) {
      setReaction(e, selectedMessageForAction, emoji);
    }
    emojiPickerOverlay.style.display = "none";
  };
  emojiGrid.appendChild(span);
});

// --- EXTENDED EMOJI LIST ---
const EXTENDED_EMOJIS = ["üòÄ","üòÉ","üòÑ","üòÅ","üòÜ","üòÖ","ü§£","üòÇ","üôÇ","üôÉ","üòâ","üòä","üòá","ü•∞","üòç","ü§©","üòò","üòó","üòö","üòô","üòã","üòõ","üòú","ü§™","üòù","ü§ë","ü§ó","ü§≠","ü§´","ü§î","ü§ê","ü§®","üòê","üòë","üò∂","üòè","üòí","üôÑ","üò¨","ü§•","üòå","üòî","üò™","ü§§","üò¥","üò∑","ü§í","ü§ï","ü§¢","ü§Æ","ü§ß","ü•µ","ü•∂","ü•¥","üòµ","ü§Ø","ü§†","ü•≥","üòé","ü§ì","üßê","üòï","üòü","üôÅ","‚òπÔ∏è","üòÆ","üòØ","üò≤","üò≥","ü•∫","üò¶","üòß","üò®","üò∞","üò•","üò¢","üò≠","üò±","üòñ","üò£","üòû","üòì","üò©","üò´","ü•±","üò§","üò°","üò†","ü§¨","üòà","üëø","üíÄ","‚ò†Ô∏è","üí©","ü§°","üëπ","üë∫","üëª","üëΩ","üëæ","ü§ñ","üò∫","üò∏","üòπ","üòª","üòº","üòΩ","üôÄ","üòø","üòæ","üëã","ü§ö","üñê","‚úã","üññ","üëå","ü§è","‚úåÔ∏è","ü§û","ü§ü","ü§ò","ü§ô","üëà","üëâ","üëÜ","üñï","üëá","‚òùÔ∏è","üëç","üëé","‚úä","üëä","ü§õ","ü§ú","üëè","üôå","üëê","ü§≤","ü§ù","üôè","‚úçÔ∏è","üíÖ","ü§≥","üí™","ü¶µ","ü¶∂","üëÇ","ü¶ª","üëÉ","üß†","ü¶∑","ü¶¥","üëÄ","üëÅ","üëÖ","üëÑ","üíã","ü©∏"];
const fullEmojiGrid = document.getElementById("emojiGrid");
if (fullEmojiGrid) {
  EXTENDED_EMOJIS.forEach((emoji) => {
    if (!EMOJI_LIST.includes(emoji)) {
      const span = document.createElement("span");
      span.innerText = emoji;
      span.onclick = (e) => {
        if (selectedMessageForAction) {
          setReaction(e, selectedMessageForAction, emoji);
        }
        emojiPickerOverlay.style.display = "none";
      };
      fullEmojiGrid.appendChild(span);
    }
  });
}

function setReaction(event, wrapper, emoji) {
  if (event) event.stopPropagation();
  const badge = wrapper.querySelector(".liked-badge");
  if (badge) badge.remove();
  let reactionDisplay = wrapper.querySelector(".reaction-display");
  if (!reactionDisplay) {
    reactionDisplay = document.createElement("div");
    reactionDisplay.className = "reaction-display";
    wrapper.appendChild(reactionDisplay);
  }
  reactionDisplay.innerHTML = emoji;
  reactionDisplay.style.display = "block";
  reactionDisplay.setAttribute("onclick", 'removeReaction(event, this.closest(".message-wrapper"))');
  updateReactionStorage(wrapper.getAttribute("data-message-id"), "standard", emoji, "add");
  hideAllActions();
}

window.removeReaction = function (event, wrapper) {
  event.stopPropagation();
  const reactionDisplay = wrapper.querySelector(".reaction-display");
  if (reactionDisplay) reactionDisplay.remove();
  updateReactionStorage(wrapper.getAttribute("data-message-id"), null, null, "remove");
};

/* --- 8. Delete Message Logic --- */
function setupDeleteAction(wrapper) {
  const overlay = wrapper.querySelector(".message-actions-overlay");
  if (overlay.querySelector(".delete-action-btn")) return;
  const isSent = wrapper.classList.contains("message-sent");
  const deleteBtn = document.createElement("span");
  deleteBtn.className = "action-btn delete-action-btn";
  deleteBtn.innerHTML = '<i class="bi bi-trash3"></i>Delete';
  deleteBtn.onclick = (e) => openDeleteModal(e, wrapper, isSent);
  const copyBtn = overlay.querySelector("span.action-btn:last-of-type");
  if (copyBtn) copyBtn.insertAdjacentElement("afterend", deleteBtn);
  else overlay.appendChild(deleteBtn);
}

function openDeleteModal(event, wrapper, isSentByMe) {
  event.stopPropagation();
  selectedMessageForAction = wrapper;
  hideAllActions();
  const buttonsToRemove = modalBtnGroup.querySelectorAll("button:not(.cancel-btn)");
  buttonsToRemove.forEach((btn) => btn.remove());
  const deleteForMeClone = document.createElement("button");
  deleteForMeClone.innerText = "Delete for me";
  deleteForMeClone.className = "btn";
  const templateBtn = document.getElementById("deleteForMeBtn");
  if (templateBtn) deleteForMeClone.setAttribute("style", templateBtn.getAttribute("style"));
  deleteForMeClone.onclick = () => { deleteMessage(wrapper, false); };
  modalBtnGroup.appendChild(deleteForMeClone);
  if (isSentByMe) {
    const deleteForEveryoneBtn = document.createElement("button");
    deleteForEveryoneBtn.id = "deleteForEveryoneBtn";
    deleteForEveryoneBtn.innerText = "Delete for everyone";
    deleteForEveryoneBtn.onclick = () => { deleteMessage(wrapper, true); };
    modalBtnGroup.appendChild(deleteForEveryoneBtn);
  }
  deleteModal.style.display = "flex";
  document.getElementById("deleteCancelBtn").onclick = () => {
    deleteModal.style.display = "none";
    selectedMessageForAction = null;
  };
}

function deleteMessage(wrapper, deleteForEveryone) {
  if (!wrapper) { deleteModal.style.display = "none"; return; }
  const messageId = wrapper.getAttribute("data-message-id");
  wrapper.remove();
  deleteModal.style.display = "none";
  selectedMessageForAction = null;
  updateReactionStorage(messageId, null, null, "remove");
  if (activeReplyData.id === messageId) resetReply();
  
  saveChatToStorage(); // SAVE CHAT
}

/* --- 3. Reply Logic --- */
window.replyToMessage = function (el, userName, messageText) {
  const wrapper = el.closest(".message-wrapper");
  const messageId = wrapper.getAttribute("data-message-id");
  let mediaUrl = wrapper.getAttribute("data-media-url");
  let mediaType = wrapper.getAttribute("data-media-type");
  let captionText = messageText || "";

  if (!mediaUrl || !mediaType) {
    const img = wrapper.querySelector("img.message-image");
    const video = wrapper.querySelector("video.message-image");
    const audio = wrapper.querySelector(".custom-audio-player");
    const caption = wrapper.querySelector(".message-caption");
    const viewOnce = wrapper.querySelector(".view-once-bubble-content");

    if (img) {
      mediaUrl = img.src; mediaType = "image"; captionText = caption ? caption.textContent.trim() : "";
    } else if (video) {
      mediaUrl = video.src; mediaType = "video"; captionText = caption ? caption.textContent.trim() : "";
    } else if (audio) {
      mediaType = "audio"; captionText = "";
    } else if (viewOnce) {
      mediaType = "image"; captionText = "Photo"; mediaUrl = "";
    }
  }

  let previewHTML = captionText || messageText || "";
  if (mediaType === "image" && mediaUrl) {
    previewHTML = `<div class="reply-media-preview-container"><span style="display:flex; align-items:center; gap:5px; color:#ccc; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"><i class="bi bi-image" style="color:var(--neon-blue)"></i> ${captionText || "Photo"}</span><img src="${mediaUrl}" class="reply-thumb-img"></div>`;
  } else if (mediaType === "video") {
    previewHTML = `<div style="display:flex; align-items:center; gap:5px; color:#ccc;"><i class="bi bi-camera-reels" style="color:var(--neon-blue)"></i> Video ${captionText ? `: ${captionText}` : ""}</div>`;
  } else if (mediaType === "audio") {
    previewHTML = `<div style="display:flex; align-items:center; gap:5px; color:#ccc;"><i class="bi bi-mic-fill" style="color:var(--neon-blue)"></i> Voice Message</div>`;
  } else if (mediaType === "image" && !mediaUrl) {
    previewHTML = `<div style="display:flex; align-items:center; gap:5px; color:#ccc;"><i class="bi bi-1-circle" style="color:var(--neon-blue)"></i> Photo</div>`;
  }

  if (!messageId) wrapper.setAttribute("data-message-id", Date.now());
  activeReplyData = { id: wrapper.getAttribute("data-message-id"), user: userName, text: messageText, preview: previewHTML, mediaUrl: mediaUrl, mediaType: mediaType };
  hideAllActions();
  replyingToUser.innerText = activeReplyData.user;
  replyTextPreview.innerHTML = activeReplyData.preview;
  replyUI.style.display = "flex";
  msgInput.focus();
};

closeReplyUI.addEventListener("click", resetReply);
function resetReply() {
  replyUI.style.display = "none";
  activeReplyData = { id: null, user: "", text: "", preview: "", mediaUrl: null, mediaType: null };
}

window.scrollToReply = function (replyId) {
  const target = document.querySelector(`.message-wrapper[data-message-id="${replyId}"]`);
  if (target) {
    target.scrollIntoView({ behavior: "smooth", block: "center" });
    const bubble = target.querySelector(".message-bubble");
    if (bubble) {
      const originalBackground = target.classList.contains("message-sent") ? bubble.style.background : bubble.style.backgroundColor;
      bubble.style.transition = "background-color 0.5s ease";
      bubble.style.backgroundColor = "rgba(188, 19, 254, 0.4)";
      setTimeout(() => {
        if (target.classList.contains("message-sent")) bubble.style.background = "var(--gradient-neon)";
        else bubble.style.background = originalBackground.includes("rgba") ? originalBackground : "rgba(40, 40, 40, 0.8)";
      }, 1500);
    }
  }
};

/* --- 4. Sending & Recording --- */
actionBtn.addEventListener("click", () => {
  if (sendIcon.style.display === "block") sendMessage(msgInput.value);
  else startRecording();
});

function createReplyBlockHTML() {
  if (!activeReplyData.id) return "";
  return `<div class="reply-in-bubble" onclick="event.stopPropagation(); scrollToReply('${activeReplyData.id}')"><small>${activeReplyData.user}</small><div class="reply-content">${activeReplyData.preview || activeReplyData.text}</div></div>`;
}

function sendMessage(text) {
  if (!text && !activeReplyData.id) return;
  const replyHTML = createReplyBlockHTML();
  const messageId = Date.now();
  const replyDataAttr = activeReplyData.id ? ` data-reply-to="${activeReplyData.id}"` : "";
  const escapedText = text.replace(/'/g, "\\'").replace(/\n/g, "<br>");
  const msgHTML = `<div class="message-wrapper message-sent" data-message-id="${messageId}"${replyDataAttr}><div class="message-bubble" onclick="toggleActions(event, this)">${replyHTML}<div>${escapedText}</div></div><div class="message-actions-overlay"><span class="action-btn" onclick="replyToMessage(this, 'You', '${escapedText}')"><i class="bi bi-arrow-return-left"></i>R√©pondre</span><span class="action-btn" onclick="copyMessage(this)"><i class="bi bi-copy"></i>Copier</span></div></div>`;
  chatBody.insertAdjacentHTML("beforeend", msgHTML);
  chatBody.scrollTop = chatBody.scrollHeight;
  msgInput.value = "";
  iconsGroup.classList.remove("hidden");
  micIcon.style.display = "block";
  sendIcon.style.display = "none";
  resetReply();
  
  saveChatToStorage(); // SAVE CHAT
}

/* Audio Functions */
async function startRecording() {
  try {
    const audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(audioStream);
    audioChunks = [];
    mediaRecorder.ondataavailable = (event) => audioChunks.push(event.data);
    mediaRecorder.onstop = () => {
      const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
      const audioUrl = URL.createObjectURL(audioBlob);
      const audio = new Audio(audioUrl);
      audio.onloadedmetadata = () => {
        let duration = audio.duration;
        if (duration === Infinity || isNaN(duration)) duration = 0;
        sendCustomAudioPlayer(audioUrl, Math.ceil(duration));
      };
      audio.load();
    };
    mediaRecorder.start();
    isRecording = true;
    recordingUI.style.display = "flex";
    startTimer();
    resetReply();
    userStatus.innerText = "Recording audio...";
    userStatus.style.color = "#ff0055";
  } catch (err) { alert("Allow mic access!"); }
}
cancelRecordBtn.addEventListener("click", () => {
  if (mediaRecorder && mediaRecorder.state === "recording") { mediaRecorder.stop(); mediaRecorder.onstop = null; }
  resetRecordingUI();
});
sendRecordBtn.addEventListener("click", () => {
  if (mediaRecorder && mediaRecorder.state === "recording") mediaRecorder.stop();
  resetRecordingUI();
});
function resetRecordingUI() {
  recordingUI.style.display = "none";
  isRecording = false;
  stopTimer();
  userStatus.innerText = "Online";
  userStatus.style.color = "#00f2ff";
}
function startTimer() {
  seconds = 0; recordTime.innerText = "0:00";
  timerInterval = setInterval(() => {
    seconds++;
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    recordTime.innerText = `${mins}:${secs < 10 ? "0" : ""}${secs}`;
  }, 1000);
}
function stopTimer() { clearInterval(timerInterval); }

/* --- DOUBLE TAP HEART (Persistent) --- */
document.addEventListener("dblclick", function (e) {
  const bubble = e.target.closest(".message-bubble");
  if (bubble) {
    const heart = document.createElement("i");
    heart.className = "bi bi-heart-fill heart-reaction";
    bubble.style.position = "relative";
    bubble.appendChild(heart);
    setTimeout(() => heart.remove(), 1000);
    const wrapper = bubble.closest(".message-wrapper");
    let existingBadge = wrapper.querySelector(".liked-badge");
    if (existingBadge) {
      existingBadge.remove();
      updateReactionStorage(wrapper.getAttribute("data-message-id"), null, null, "remove");
    } else {
      const reactionDisplay = wrapper.querySelector(".reaction-display");
      if (reactionDisplay) reactionDisplay.remove();
      const badge = document.createElement("i");
      badge.className = "bi bi-heart-fill liked-badge";
      wrapper.appendChild(badge);
      updateReactionStorage(wrapper.getAttribute("data-message-id"), "badge", "‚ù§Ô∏è", "add");
    }
  }
});

/* --- Image/Video Handling (UPDATED WITH CROP & MULTI-SELECT & LOCALSTORAGE) --- */

const btnCrop = document.getElementById("btnCrop");
const btnRotate = document.getElementById("btnRotate");
const btnEnhance = document.getElementById("btnEnhance");
let newCropper = null;
let previewImgEl = null;

// Update Gallery Input to accept multiple files
galleryInput.setAttribute("multiple", ""); 

triggerGallery.addEventListener("click", () => galleryInput.click());
changeMediaInPreviewBtn.addEventListener("click", () => galleryInput.click());

// Multi-select Logic with FileReader (For Persistence)
galleryInput.addEventListener("change", (e) => {
    if (e.target.files && e.target.files.length > 0) {
        const files = Array.from(e.target.files);
        let processedCount = 0;

        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = (event) => {
                mediaQueue.push({
                    url: event.target.result, // Base64 (Saved safely)
                    type: file.type.startsWith("video/") ? "video" : "image",
                    file: file
                });
                processedCount++;
                
                // Only open preview when all files are read
                if(processedCount === files.length) {
                     if (mediaQueue.length === files.length) { 
                        currentMediaIndex = 0;
                        openPreviewMulti();
                    } else {
                        renderThumbnails();
                        currentMediaIndex = mediaQueue.length - 1;
                        updateMainPreview();
                    }
                }
            };
            reader.readAsDataURL(file);
        });
    }
    galleryInput.value = "";
});

// Camera Logic: Capture to Queue
triggerCamera.addEventListener("click", async () => {
    try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        cameraVideo.srcObject = stream;
        cameraOverlay.style.display = "flex";
    } catch (err) { alert("Camera Error! " + err.message); }
});

captureBtn.addEventListener("click", () => {
    if (cameraVideo.readyState >= 2) {
        cameraCanvas.width = cameraVideo.videoWidth;
        cameraCanvas.height = cameraVideo.videoHeight;
        const ctx = cameraCanvas.getContext("2d");
        ctx.drawImage(cameraVideo, 0, 0);
        const imageUrl = cameraCanvas.toDataURL("image/png"); // Base64 (Safe)
        
        closeCameraFunc();

        // Push Camera Image to Queue
        mediaQueue.push({
            url: imageUrl,
            type: "image"
        });
        
        // Open Preview
        if(mediaQueue.length === 1) {
            currentMediaIndex = 0;
            openPreviewMulti();
        } else {
            currentMediaIndex = mediaQueue.length - 1;
            if(imagePreviewOverlay.style.display !== 'flex') openPreviewMulti();
            else { renderThumbnails(); updateMainPreview(); }
        }
    }
});

function closeCameraFunc() {
    if (stream) stream.getTracks().forEach((track) => track.stop());
    cameraOverlay.style.display = "none";
}
closeCameraBtn.addEventListener("click", closeCameraFunc);


// Open Preview Overlay
function openPreviewMulti() {
    imagePreviewOverlay.style.display = "flex";
    updateMainPreview();
    renderThumbnails();
}

// Update the Main Preview Area
function updateMainPreview() {
    const container = document.getElementById("previewMediaContainer");
    container.innerHTML = "";
    
    if(mediaQueue.length === 0) return;

    const media = mediaQueue[currentMediaIndex];
    currentMediaUrl = media.url; 
    currentMediaType = media.type;

    if (media.type === "video") {
        const vid = document.createElement("video");
        vid.src = media.url;
        vid.controls = true;
        vid.style.maxWidth = "100%";
        vid.style.maxHeight = "100%";
        container.appendChild(vid);
        previewTools.style.display = "none";
    } else {
        const img = document.createElement("img");
        img.src = media.url;
        img.id = "previewImageElement";
        img.style.maxWidth = "100%";
        img.style.maxHeight = "100%";
        container.appendChild(img);
        previewImgEl = img;
        previewTools.style.display = "flex";
    }
    renderThumbnails();
    
    // Destroy cropper if switching images
    if (newCropper) {
        newCropper.destroy();
        newCropper = null;
        cropControls.style.display = "none";
        previewTools.style.display = "flex";
        closePreviewBtnIcon.style.display = "block";
    }
}

// Render Thumbnails
function renderThumbnails() {
    mediaThumbnails.innerHTML = "";
    if (mediaQueue.length < 2) {
        mediaThumbnails.style.display = "none";
        return;
    }
    mediaThumbnails.style.display = "flex";

    mediaQueue.forEach((item, index) => {
        const thumb = document.createElement(item.type === 'video' ? 'video' : 'img');
        thumb.src = item.url;
        thumb.className = `mini-thumb ${index === currentMediaIndex ? 'active-thumb' : ''}`;
        thumb.onclick = () => {
            currentMediaIndex = index;
            updateMainPreview();
        };
        mediaThumbnails.appendChild(thumb);
    });
}

// Close Preview
closePreviewBtn.addEventListener("click", () => {
    imagePreviewOverlay.style.display = "none";
    captionInput.value = "";
    isViewOnceMode = false;
    isViewingViewOnce = false;
    viewOnceToggle.classList.remove("active");
    if (newCropper) { newCropper.destroy(); newCropper = null; }
    
    // Clear Queue
    mediaQueue = [];
    currentMediaIndex = 0;
    mediaThumbnails.innerHTML = "";

    const openedMsg = document.querySelector(".temp-viewing");
    if (openedMsg) {
        openedMsg.classList.remove("temp-viewing");
        const bubble = openedMsg.querySelector(".message-bubble");
        if (bubble) {
            bubble.innerHTML = '<div class="view-once-bubble-content view-once-opened"><div class="view-once-icon-circle" style="border-color:#888;">1</div> Opened</div>';
            bubble.removeAttribute("onclick");
            openedMsg.removeAttribute("onclick");
            
            saveChatToStorage(); // Save "Opened" state
        }
    }
});

// CROP LOGIC
btnCrop.addEventListener("click", () => {
    if (!previewImgEl) return;
    previewTools.style.display = "none";
    closePreviewBtnIcon.style.display = "none";
    cropControls.style.display = "flex";

    if (newCropper) { newCropper.destroy(); }
    newCropper = new Cropper(previewImgEl, {
        viewMode: 1,
        autoCropArea: 1,
        background: false,
    });
});

btnCropCancel.addEventListener("click", () => {
    if (newCropper) { newCropper.destroy(); newCropper = null; }
    cropControls.style.display = "none";
    previewTools.style.display = "flex";
    closePreviewBtnIcon.style.display = "block";
});

btnCropDone.addEventListener("click", () => {
    if (newCropper) {
        const canvas = newCropper.getCroppedCanvas();
        const croppedUrl = canvas.toDataURL();
        
        // Update Queue
        mediaQueue[currentMediaIndex].url = croppedUrl;
        
        // Update View
        previewImgEl.src = croppedUrl;
        renderThumbnails();

        newCropper.destroy();
        newCropper = null;
    }
    cropControls.style.display = "none";
    previewTools.style.display = "flex";
    closePreviewBtnIcon.style.display = "block";
});

btnRotate.addEventListener("click", () => {
    if (newCropper) newCropper.rotate(90);
});

btnEnhance.addEventListener("click", () => {
    if (!previewImgEl) return;
    if (previewImgEl.style.filter === "brightness(1.1) contrast(1.1)") {
        previewImgEl.style.filter = "none";
        btnEnhance.style.color = "var(--neon-blue)";
    } else {
        previewImgEl.style.filter = "brightness(1.1) contrast(1.1)";
        btnEnhance.style.color = "white";
    }
});

viewOnceToggle.addEventListener("click", () => {
    isViewOnceMode = !isViewOnceMode;
    if (isViewOnceMode) viewOnceToggle.classList.add("active");
    else viewOnceToggle.classList.remove("active");
});

// SEND LOGIC (Loop through Queue)
// Replace clone to ensure clean listener
// --- IMPORTANT: UPDATE SEND BUTTON (FIXED) ---
const originalSendBtn = confirmSendImgBtn.cloneNode(true);
confirmSendImgBtn.parentNode.replaceChild(originalSendBtn, confirmSendImgBtn);

originalSendBtn.addEventListener("click", async () => {
    if(mediaQueue.length === 0) return;

    // 1. Check Crop
    if(newCropper) {
        const canvas = newCropper.getCroppedCanvas();
        mediaQueue[currentMediaIndex].url = canvas.toDataURL();
    }
    
    // 2. Check Filters
    if (currentMediaType === "image" && previewImgEl && previewImgEl.style.filter && previewImgEl.style.filter !== "none") {
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        const img = new Image();
        img.src = mediaQueue[currentMediaIndex].url;
        await new Promise(r => img.onload = r);
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.filter = "brightness(110%) contrast(110%)";
        ctx.drawImage(img, 0, 0);
        mediaQueue[currentMediaIndex].url = canvas.toDataURL();
    }

    // 3. SEND ALL (With try/catch to ensure window closes)
    try {
        for (let i = 0; i < mediaQueue.length; i++) {
            const item = mediaQueue[i];
            const captionToSend = (i === mediaQueue.length - 1) ? captionInput.value : ""; 
            await sendMediaMessage(item.url, captionToSend, item.type);
        }
    } catch (err) {
        console.log("Error during send (likely Storage Full):", err);
    }

    // ÿØÿßÿ®ÿß ŸáÿßÿØŸä ÿ∫ÿ™ÿÆÿØŸÖ ÿ®ÿ≤ÿ≤ ŸàÿßÿÆÿß ŸäŸÉŸàŸÜ Error ŸÅÿßŸÑÿ™ÿÆÿ≤ŸäŸÜ
    finishSend();
});

function finishSend() {
    imagePreviewOverlay.style.display = "none";
    captionInput.value = "";
    currentMediaUrl = null;
    isViewOnceMode = false;
    viewOnceToggle.classList.remove("active");
    // Clear Queue
    mediaQueue = [];
    currentMediaIndex = 0;
    mediaThumbnails.innerHTML = "";
}

function sendMediaMessage(url, caption, type = "image") {
  return new Promise(resolve => {
      const replyHTML = createReplyBlockHTML();
      const messageId = Date.now() + Math.random(); // Ensure unique ID
      const escapedCaption = caption.replace(/'/g, "\\'").replace(/\n/g, "<br>");
      let mediaHTML = "";
      let captionHTML = "";
      if (isViewOnceMode) {
        mediaHTML = `<div class="view-once-bubble-content" onclick="openViewOnceMedia(this, '${url}', '${type}')"><div class="view-once-icon-circle">1</div><span>Photo</span></div>`;
      } else {
        mediaHTML = type === "video"
            ? `<video src="${url}" class="message-image" controls style="background: black; width: 100%; border-radius: 10px;"></video>`
            : `<img src="${url}" class="message-image" style="width: 100%; border-radius: 10px;">`;
        captionHTML = caption.trim() !== ""
            ? `<div class="message-caption" style="margin-top: 8px; text-shadow: 0 0 5px var(--neon-purple); font-weight: 600;">${escapedCaption}</div>`
            : "";
      }
      const replyDataAttr = activeReplyData.id ? ` data-reply-to="${activeReplyData.id}"` : "";
      const msgHTML = `<div class="message-wrapper message-sent" data-message-id="${messageId}"${replyDataAttr} data-media-url="${url}" data-media-type="${type}"><div class="message-bubble" style="padding:10px; background:var(--gradient-neon); display:flex; flex-direction:column; gap:8px;" onclick="toggleActions(event, this)">${replyHTML}<div style="display: flex; flex-direction: column;">${mediaHTML}${captionHTML}</div></div><div class="message-actions-overlay"><span class="action-btn" onclick="replyToMessage(this, 'You', '${escapedCaption}')"><i class="bi bi-arrow-return-left"></i>R√©pondre</span><span class="action-btn" onclick="copyMessage(this)"><i class="bi bi-copy"></i>Copier</span></div></div>`;
      chatBody.insertAdjacentHTML("beforeend", msgHTML);
      chatBody.scrollTop = chatBody.scrollHeight;
      
      saveChatToStorage(); // SAVE CHAT
      resolve();
  });
}

window.openViewOnceMedia = function (el, url, type) {
  event.stopPropagation();
  // Open Preview in "View Only" mode (no tools)
  const container = document.getElementById("previewMediaContainer");
  container.innerHTML = "";
  if (type === "video") {
    const vid = document.createElement("video");
    vid.src = url; vid.controls = true; vid.style.maxWidth = "100%";
    container.appendChild(vid);
  } else {
    const img = document.createElement("img");
    img.src = url; img.style.maxWidth = "100%"; img.style.maxHeight = "100%";
    container.appendChild(img);
  }
  imagePreviewOverlay.style.display = "flex";
  
  document.getElementById("previewTools").style.display = "none";
  document.getElementById("previewBottomBar").style.display = "none";
  document.getElementById("mediaThumbnails").style.display = "none"; 
  
  const wrapper = el.closest(".message-wrapper");
  wrapper.classList.add("temp-viewing");
  isViewingViewOnce = true;
};

function sendCustomAudioPlayer(url, duration) {
  const mins = Math.floor(duration / 60);
  const secs = duration % 60;
  const formattedDuration = `${mins}:${secs < 10 ? "0" : ""}${secs}`;
  const replyHTML = createReplyBlockHTML();
  const messageId = Date.now();
  const replyDataAttr = activeReplyData.id ? ` data-reply-to="${activeReplyData.id}"` : "";
  const avatarUrl = "https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=100&q=80"; // Avatar
  const playerHTML = `<div class="message-wrapper message-sent" data-message-id="${messageId}"${replyDataAttr} data-media-type="audio"><div class="message-bubble" style="padding: 10px; background: transparent; box-shadow: none; display: flex; flex-direction: column;" onclick="toggleActions(event, this)">${replyHTML}<div class="custom-audio-player"><div class="audio-play-circle" onclick="toggleAudio(this)"><i class="bi bi-play-fill"></i><audio src="${url}"></audio></div><div class="audio-white-bar"><div class="audio-wave-container"><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div></div><span class="audio-time">0:00 / ${formattedDuration}</span></div><img src="${avatarUrl}" class="audio-avatar" alt="Profile"></div></div><div class="message-actions-overlay"><span class="action-btn" onclick="replyToMessage(this, 'You', '')"><i class="bi bi-arrow-return-left"></i>R√©pondre</span><span class="action-btn" onclick="copyMessage(this)"><i class="bi bi-copy"></i>Copier</span></div></div>`;
  chatBody.insertAdjacentHTML("beforeend", playerHTML);
  chatBody.scrollTop = chatBody.scrollHeight;
  resetReply();
  
  saveChatToStorage(); // SAVE CHAT
}

window.toggleAudio = function (btn) {
  document.querySelectorAll(".custom-audio-player audio").forEach((a) => {
    if (a !== btn.querySelector("audio") && !a.paused) {
      a.pause();
      const parent = a.closest(".custom-audio-player");
      parent.querySelector(".audio-play-circle i").classList.remove("bi-pause-fill");
      parent.querySelector(".audio-play-circle i").classList.add("bi-play-fill");
      parent.querySelector(".audio-wave-container").classList.remove("wave-active");
    }
  });
  const audio = btn.querySelector("audio");
  const icon = btn.querySelector("i");
  const waveContainer = btn.nextElementSibling.querySelector(".audio-wave-container");
  const timeDisplay = btn.nextElementSibling.querySelector(".audio-time");
  const totalDuration = timeDisplay.innerText.split(" / ")[1] || "0:00";
  if (audio.paused) {
    audio.play();
    icon.classList.remove("bi-play-fill"); icon.classList.add("bi-pause-fill");
    waveContainer.classList.add("wave-active");
  } else {
    audio.pause();
    icon.classList.remove("bi-pause-fill"); icon.classList.add("bi-play-fill");
    waveContainer.classList.remove("wave-active");
  }
  audio.ontimeupdate = () => {
    const currentMins = Math.floor(audio.currentTime / 60);
    const currentSecs = Math.floor(audio.currentTime % 60);
    const formattedCurrent = `${currentMins}:${currentSecs < 10 ? "0" : ""}${currentSecs}`;
    timeDisplay.innerText = `${formattedCurrent} / ${totalDuration}`;
  };
  audio.onended = () => {
    icon.classList.remove("bi-pause-fill"); icon.classList.add("bi-play-fill");
    waveContainer.classList.remove("wave-active");
    audio.currentTime = 0;
    timeDisplay.innerText = `0:00 / ${totalDuration}`;
  };
};

/* --- INIT & RESTORE --- */
/* --- INIT & RESTORE --- */
document.addEventListener("DOMContentLoaded", () => {
  
  // 1. Jib smiyat l-user men l-URL (Hadi hiya li kat7el l-mochkil)
  const urlParams = new URLSearchParams(window.location.search);
  const currentUserChatID = urlParams.get('user') || 'default';

  // 2. Sawbna sarout (Key) khass bhad l-user
  const localHistoryKey = `savedChatHistory_${currentUserChatID}`;
  const localReactionsKey = `chatReactions_${currentUserChatID}`;

  // 3. Restore Chat History (MESSAGES)
  const savedChat = localStorage.getItem(localHistoryKey);
  
  if (savedChat) {
    chatBody.innerHTML = savedChat;
    chatBody.scrollTop = chatBody.scrollHeight;
  } else {
    // Ila kan user jdid, khwi chatBody bash maybanouch missajat 9dam
    chatBody.innerHTML = '';
  }

  // 4. Re-attach Event Listeners (Delete & Emoji)
  document.querySelectorAll(".message-wrapper").forEach((wrapper) => {
    if (!wrapper.getAttribute("data-message-id")) {
      wrapper.setAttribute("data-message-id", Date.now() + Math.random());
    }
    setupDeleteAction(wrapper);
    setupEmojiActions(wrapper);
  });
  
  deleteForMeBtnCloneTarget.style.display = "none";

  // 5. Restore Wallpaper (Hada bqa Global b7al dima)
  const savedWallpaper = localStorage.getItem("chatWallpaper");
  if (savedWallpaper) {
    const mobileContainer = document.querySelector(".mobile-container");
    if (mobileContainer) {
      mobileContainer.style.backgroundImage = `url('${savedWallpaper}')`;
      mobileContainer.style.backgroundSize = "cover";
      mobileContainer.style.backgroundPosition = "center";
      mobileContainer.style.backgroundRepeat = "no-repeat";
    }
  }

  // 6. Restore Reactions (Using Dynamic Key)
  const savedReactions = JSON.parse(localStorage.getItem(localReactionsKey) || "{}");
  
  for (const [msgId, data] of Object.entries(savedReactions)) {
    const wrapper = document.querySelector(`.message-wrapper[data-message-id="${msgId}"]`);
    if (wrapper) {
      // Clear existing badges/reactions first to avoid duplicates
      const existingBadge = wrapper.querySelector(".liked-badge");
      if(existingBadge) existingBadge.remove();
      const existingReaction = wrapper.querySelector(".reaction-display");
      if(existingReaction) existingReaction.remove();

      if (data.type === "badge") {
        const badge = document.createElement("i");
        badge.className = "bi bi-heart-fill liked-badge";
        wrapper.appendChild(badge);
      } else if (data.type === "standard") {
        let reactionDisplay = document.createElement("div");
        reactionDisplay.className = "reaction-display";
        reactionDisplay.innerHTML = data.emoji;
        reactionDisplay.style.display = "block";
        reactionDisplay.setAttribute("onclick", 'removeReaction(event, this.closest(".message-wrapper"))');
        wrapper.appendChild(reactionDisplay);
      }
    }
  }
});

/* --- Wallpaper Changer --- */
const changeWallpaperBtn = document.getElementById("changeWallpaperBtn");
const wallpaperInput = document.getElementById("wallpaperInput");
if (changeWallpaperBtn && wallpaperInput) {
  changeWallpaperBtn.addEventListener("click", () => { wallpaperInput.click(); });
  wallpaperInput.addEventListener("change", (e) => {
    if (e.target.files && e.target.files[0]) {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = function (event) {
        const bgUrl = event.target.result;
        try { localStorage.setItem("chatWallpaper", bgUrl); } catch (err) {}
        const mobileContainer = document.querySelector(".mobile-container");
        if (mobileContainer) {
          mobileContainer.style.backgroundImage = `url('${bgUrl}')`;
          mobileContainer.style.backgroundSize = "cover";
          mobileContainer.style.backgroundPosition = "center";
          mobileContainer.style.backgroundRepeat = "no-repeat";
        }
      };
      reader.readAsDataURL(file);
    }
  });
}

/* === NEW: INPUT EMOJI PICKER LOGIC === */
const triggerInputEmoji = document.getElementById("triggerInputEmoji");
const inputEmojiPicker = document.getElementById("inputEmojiPicker");
if (triggerInputEmoji && inputEmojiPicker) {
  const ALL_INPUT_EMOJIS = [...EMOJI_LIST, ...EXTENDED_EMOJIS];
  const uniqueInputEmojis = [...new Set(ALL_INPUT_EMOJIS)];
  uniqueInputEmojis.forEach((emoji) => {
    const span = document.createElement("span");
    span.innerText = emoji;
    span.onclick = (e) => { e.stopPropagation(); insertAtCursor(msgInput, emoji); };
    inputEmojiPicker.appendChild(span);
  });
  triggerInputEmoji.addEventListener("click", (e) => {
    e.stopPropagation();
    if (inputEmojiPicker.style.display === "grid") { inputEmojiPicker.style.display = "none"; }
    else { inputEmojiPicker.style.display = "grid"; }
  });
  document.addEventListener("click", (e) => {
    if (!inputEmojiPicker.contains(e.target) && e.target !== triggerInputEmoji) {
      inputEmojiPicker.style.display = "none";
    }
  });
}

function insertAtCursor(myField, myValue) {
  if (document.selection) {
    myField.focus(); sel = document.selection.createRange(); sel.text = myValue;
  } else if (myField.selectionStart || myField.selectionStart == "0") {
    var startPos = myField.selectionStart; var endPos = myField.selectionEnd;
    myField.value = myField.value.substring(0, startPos) + myValue + myField.value.substring(endPos, myField.value.length);
    myField.selectionStart = startPos + myValue.length; myField.selectionEnd = startPos + myValue.length;
  } else { myField.value += myValue; }
  const event = new Event("input", { bubbles: true, cancelable: true });
  myField.dispatchEvent(event); myField.focus();
}

/* --- ATTACHMENT MENU TOGGLE --- */
const toggleAttachBtn = document.getElementById("toggleAttachBtn");
const attachMenu = document.getElementById("attachMenu");
if (toggleAttachBtn && attachMenu) {
  toggleAttachBtn.addEventListener("click", (e) => {
    e.stopPropagation(); attachMenu.classList.toggle("attach-menu-visible");
  });
  document.getElementById("triggerCamera").addEventListener("click", () => { attachMenu.classList.remove("attach-menu-visible"); });
  document.getElementById("triggerGallery").addEventListener("click", () => { attachMenu.classList.remove("attach-menu-visible"); });
  document.addEventListener("click", (e) => {
    if (!attachMenu.contains(e.target) && e.target !== toggleAttachBtn) { attachMenu.classList.remove("attach-menu-visible"); }
  });
}
    </script>
  </body>
</html>